{% extends 'operator/base_operator.html' %}

{% block content %}
<div class="lead-edit">
    <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ #{{ lead.id }}</h2>

    <div style="margin-bottom: 25px;">
        <a href="{% url 'operator_dashboard' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∑–∞—è–≤–æ–∫</a>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ) -->
    <div class="lead-info">
        <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
        <p><strong>–§–ò–û:</strong> {{ lead.fio }}</p>
        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ lead.phone }}</p>
        <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ lead.address }}</p>
        <p><strong>–†–µ–≥–∏–æ–Ω:</strong> {{ lead.region }}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: var(--rt-purple); font-weight: 700;">{{ lead.get_status_display }}</span></p>
        <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> {{ lead.created_at|date:"d.m.Y H:i" }}</p>
        <p><strong>–û–±–Ω–æ–≤–ª–µ–Ω–∞:</strong> {{ lead.updated_at|date:"d.m.Y H:i" }}</p>
        <p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {{ user.username }}</p>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <form method="post" action="{% url 'update_lead' lead.id %}" id="leadForm">
        {% csrf_token %}

        <div style="background: var(--rt-white); padding: 25px; border-radius: var(--border-radius); margin-bottom: 25px; box-shadow: var(--shadow);">
            <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π</h3>

            <!-- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ -->
<div style="margin-bottom: 20px;">
    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--rt-purple);">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ:</label>
    <p style="background: var(--rt-cool-grey); padding: 12px; border-radius: var(--border-radius);">
        {{ lead.tariff.name }} - {{ lead.tariff.price }} ‚ÇΩ/–º–µ—Å
        {% if lead.tariff.speed %} | {{ lead.tariff.speed }}{% endif %}
    </p>

    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--rt-purple); margin-top: 15px;">
        –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ (–¥–æ—Å—Ç—É–ø–Ω–æ {{ tariffs.count }}):
    </label>

    <select name="tariff" id="tariffSelect" style="padding: 12px; width: 100%; max-width: 400px; border: 2px solid var(--rt-lavender); border-radius: var(--border-radius); font-family: 'Rostelecom Basis', Arial, sans-serif;">
        {% for tariff in tariffs %}
            <option value="{{ tariff.id }}" {% if tariff.id == lead.tariff.id %}selected{% endif %}>
                {{ tariff.name }} - {{ tariff.price }} ‚ÇΩ/–º–µ—Å
                {% if tariff.speed %} | {{ tariff.speed }}{% endif %}
                {% if tariff.region.name != lead.region %} ({{ tariff.region.name }}){% endif %}
            </option>
        {% endfor %}
    </select>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–≥–∏–æ–Ω–µ-->
    <div style="font-size: 12px; color: #666; margin-top: 5px;">
        –†–µ–≥–∏–æ–Ω –∑–∞—è–≤–∫–∏: <strong>{{ lead.region }}</strong>
        {% if tariffs.first.region.name != lead.region %}
            | –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–∞—Ä–∏—Ñ—ã –∏–∑ —Ä–µ–≥–∏–æ–Ω–∞: <strong>{{ tariffs.first.region.name }}</strong>
        {% endif %}
    </div>
</div>

            <!-- –î–∞—Ç–∞ –º–æ–Ω—Ç–∞–∂–∞ -->
            <!-- <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--rt-purple);">–î–∞—Ç–∞ –º–æ–Ω—Ç–∞–∂–∞:</label>
                <input type="datetime-local" name="installation_date" id="installationDate"
                       value="{{ lead.installation_date|date:'Y-m-d\TH:i' }}"
                       style="padding: 12px; width: 100%; max-width: 400px; border: 2px solid var(--rt-lavender); border-radius: var(--border-radius); font-family: 'Rostelecom Basis', Arial, sans-serif;">
            </div> -->

            <!-- –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--rt-purple);">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:</label>
                <select name="status" id="statusSelect" style="padding: 12px; width: 100%; max-width: 400px; border: 2px solid var(--rt-lavender); border-radius: var(--border-radius); font-family: 'Rostelecom Basis', Arial, sans-serif;">
                    {% for value, display in status_choices %}
                        <option value="{{ value }}" {% if value == lead.status %}selected{% endif %}>
                            {{ display }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--rt-purple);">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</label>
                <textarea name="notes" id="notesTextarea" style="width: 100%; height: 120px; padding: 12px; border: 2px solid var(--rt-lavender); border-radius: var(--border-radius); font-family: 'Rostelecom Basis', Arial, sans-serif;">{{ lead.notes }}</textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="actions">
                <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="button" class="btn btn-primary" onclick="saveAndStay()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <a href="{% url 'operator_dashboard' %}" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</a>
            </div>
        </div>
    </form>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–µ -->
    <div style="background: var(--rt-lavender); padding: 20px; border-radius: var(--border-radius); border-left: 4px solid var(--rt-orange);">
        <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ</h3>
        <p><strong>–°–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞:</strong> {{ lead.tariff.speed|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</p>
        <p><strong>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –¢–í:</strong> <span style="color: {% if lead.tariff.interactive_tv %}var(--rt-purple){% else %}#666{% endif %}; font-weight: 600;">{{ lead.tariff.interactive_tv|yesno:"‚úÖ –í–∫–ª—é—á–µ–Ω–æ,‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ" }}</span></p>
        <p><strong>–û–Ω–ª–∞–π–Ω –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä:</strong> <span style="color: {% if lead.tariff.online_cinema %}var(--rt-purple){% else %}#666{% endif %}; font-weight: 600;">{{ lead.tariff.online_cinema|yesno:"‚úÖ –í–∫–ª—é—á–µ–Ω–æ,‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ" }}</span></p>
        <p><strong>–ú–æ–±–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong> <span style="color: var(--rt-purple); font-weight: 600;">{{ lead.tariff.mobile_data }} –ì–ë</span></p>
        <p><strong>–ú–æ–±–∏–ª—å–Ω—ã–µ –º–∏–Ω—É—Ç—ã:</strong> <span style="color: var(--rt-purple); font-weight: 600;">{{ lead.tariff.mobile_minutes }} –º–∏–Ω</span></p>
        <p><strong>–ú–æ–±–∏–ª—å–Ω—ã–µ –°–ú–°:</strong> <span style="color: var(--rt-purple); font-weight: 600;">{{ lead.tariff.mobile_sms }} —à—Ç</span></p>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
function saveAndStay() {
    const form = document.getElementById('leadForm');
    const formData = new FormData(form);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –¥–ª—è –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    formData.append('stay_on_page', 'true');

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
    });
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('statusSelect');
    const tariffSelect = document.getElementById('tariffSelect');

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏–ª–∏ —Ç–∞—Ä–∏—Ñ–∞
    [statusSelect, tariffSelect].forEach(select => {
        select.addEventListener('change', function() {
            if (confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) {
                saveAndStay();
            }
        });
    });
});
</script>
{% endblock %}